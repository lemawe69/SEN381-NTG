@page "/chatbot"
@inject HttpClient Http

<h3 class="text-center mb-4">💬 Chat with CampusLearn Assistant</h3>

<div class="chat-box">
    @foreach (var msg in messages)
    {
        <div class="@msg.Role">
            <div class="bubble">@((MarkupString)msg.Content)</div>
        </div>
    }
</div>

<input @bind="userInput" @bind:event="oninput" @onkeydown="HandleKeyDown" placeholder="Type your message and press Enter..." class="chat-input" />

@code {
    private string userInput = "";
    private List<ChatMessage> messages = new();

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(userInput))
        {
            messages.Add(new ChatMessage("user", userInput));
            var response = await Http.PostAsJsonAsync("http://localhost:3001/chat", new { message = userInput });
            var reply = await response.Content.ReadFromJsonAsync<ChatResponse>();
            var formatted = FormatBotResponse(reply?.Reply ?? "⚠️ Error");
            messages.Add(new ChatMessage("bot", formatted));
            userInput = "";
        }
    }

    private string FormatBotResponse(string text)
    {
        string html = text
            .Replace("**", "<strong>").Replace("*", "<em>")
            .Replace("\n\n", "<br><br>")
            .Replace("\n", "<br>")
            .Replace("•", "• ");

        return html;
    }

    public class ChatMessage
    {
        public string Role { get; set; }
        public string Content { get; set; }
        public ChatMessage(string role, string content)
        {
            Role = role;
            Content = content;
        }
    }

    public class ChatResponse
    {
        public string Reply { get; set; } = string.Empty;
    }
}
